name: Publish to PyPI

on:
  # Trigger automatically when you push a version tag like v0.1.0, v1.2.3, etc.
  push:
    tags:
      - "v*"

  # Trigger manually from the GitHub UI (Actions tab) without creating a new tag.
  # You can choose which existing tag to publish.
  workflow_dispatch:
    inputs:
      tag:
        description: "Existing git tag to publish (example: v0.1.0)"
        required: true
        # You can change this default to your most common tag pattern.
        default: "v0.1.0"

permissions:
  # Required to checkout repository contents.
  contents: read
  # REQUIRED for PyPI Trusted Publishing (OIDC).
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------
      # 1) Resolve which tag we are publishing
      # --------------------------------------------
      - name: Resolve target tag
        id: resolve_tag
        shell: bash
        run: |
          set -euo pipefail

          # If triggered manually, use the input tag.
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
          else
            # If triggered by a tag push, extract the tag from GITHUB_REF.
            TAG="${GITHUB_REF#refs/tags/}"
          fi

          # Basic validation: we only accept tags starting with "v"
          if [[ ! "$TAG" =~ ^v[0-9]+(\.[0-9]+){1,3}.*$ ]]; then
            echo "❌ Invalid tag format: '$TAG' (expected something like v0.1.0)"
            exit 1
          fi

          echo "Publishing tag: $TAG"
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"

      # --------------------------------------------
      # 2) Checkout the repository *at the tag*
      #    - fetch-depth: 0 ensures tags/history are available (robust)
      # --------------------------------------------
      - name: Checkout code at tag
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.resolve_tag.outputs.tag }}
          fetch-depth: 0
          fetch-tags: true

      # --------------------------------------------
      # 3) Set up Python
      # --------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # --------------------------------------------
      # 4) Install Poetry (and upgrade pip)
      # --------------------------------------------
      - name: Install Poetry
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip
          pip install poetry

      # --------------------------------------------
      # 5) Ensure the tag version matches pyproject version
      #    - Prevents accidental publishing of mismatched versions
      # --------------------------------------------
      - name: Verify version matches tag
        shell: bash
        run: |
          set -euo pipefail

          TAG="${{ steps.resolve_tag.outputs.tag }}"
          TAG_VERSION="${TAG#v}"                 # e.g. v0.1.0 -> 0.1.0
          POETRY_VERSION="$(poetry version -s)"  # reads version from pyproject.toml

          echo "Tag version:    $TAG_VERSION"
          echo "Poetry version:  $POETRY_VERSION"

          if [[ "$TAG_VERSION" != "$POETRY_VERSION" ]]; then
            echo "❌ Error: Version mismatch (tag=$TAG_VERSION, pyproject=$POETRY_VERSION)"
            exit 1
          fi

          echo "✅ Version match confirmed"

      # --------------------------------------------
      # 6) Build distributions (sdist + wheel)
      # --------------------------------------------
      - name: Build package
        shell: bash
        run: |
          set -euo pipefail
          poetry build
          ls -lh dist/

      # --------------------------------------------
      # 7) Publish to PyPI via Trusted Publishing (OIDC)
      #    - Requires PyPI project configured as a "Trusted Publisher"
      # --------------------------------------------
      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: dist/
          print-hash: true
